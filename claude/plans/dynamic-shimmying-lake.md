# Configure per-project plans and document task naming

## Context

Plans default to `~/.claude/plans/` with random names. Task naming is already solved via `claude()` wrapper in `config/aliases.sh` (auto-generates `YYYYMMDD_HHmmss_UTC_<dirname>`). The `workflow-defaults.md` rules file has two fake env vars that do nothing.

## Verified facts (official docs + GitHub issues)

| Feature | Status | Source |
|---------|--------|--------|
| `plansDirectory` in settings.json | **Works** (global only; project-level buggy) | [docs](https://code.claude.com/docs/en/settings), [#18623](https://github.com/anthropics/claude-code/issues/18623) |
| `tasksDirectory` in settings.json | **Not implemented** | [#20425](https://github.com/anthropics/claude-code/issues/20425) |
| Descriptive plan file names | **Not configurable** — system generates random names | [#18596](https://github.com/anthropics/claude-code/issues/18596), [#21342](https://github.com/anthropics/claude-code/issues/21342) |
| `CLAUDE_CODE_TASK_LIST_ID` env var | **Works** — already used by `claude()` wrapper | [docs](https://code.claude.com/docs/en/settings) |
| `CLAUDE_CODE_PLANS_DIR` env var | **Does not exist** | — |
| `CLAUDE_CODE_TASKS_DIR` env var | **Does not exist** | — |

### Existing task naming (already works — `config/aliases.sh`)
- `claude()` wrapper (line 33): auto-generates `YYYYMMDD_HHmmss_UTC_<dirname>`, supports `-t <name>` flag
- `claude-new <desc>`: custom task list name, saves to `.claude_task_list_id`
- `claude-last`: resume previous task list
- `claude-with <id>`: use specific task list
- `claude-tasks-list`: list all task lists
- `yn <name>`: alias for `yolo -t <name>`

**Note:** There's a duplicate `claude()` at line 311 that overrides the richer version at line 33. May want to remove the simpler duplicate.

### Known limitations to revisit
- [#18623](https://github.com/anthropics/claude-code/issues/18623): `plansDirectory` in project-level settings.json ignored
- [#18596](https://github.com/anthropics/claude-code/issues/18596): Plan naming ignores CLAUDE.md instructions
- [#21342](https://github.com/anthropics/claude-code/issues/21342): Feature request for descriptive plan names
- [#17871](https://github.com/anthropics/claude-code/issues/17871): Plan directory config partially implemented with bugs
- [#20425](https://github.com/anthropics/claude-code/issues/20425): `tasksDirectory` setting not yet available
- [#18777](https://github.com/anthropics/claude-code/issues/18777): Tasks lack descriptive info in agent reporting

## Changes

### 1. Add `plansDirectory` to global settings.json

**File:** `claude/settings.json`

```json
"plansDirectory": ".claude/plans"
```

Relative path resolved from project root → every project gets `<repo>/.claude/plans/`.

### 2. Update `workflow-defaults.md`

**File:** `claude/rules/workflow-defaults.md`

Replace lines 10-18 (fake exports + unsupported naming claims):

```markdown
**Plan Naming:** System auto-generates random names — not yet configurable ([#21342](https://github.com/anthropics/claude-code/issues/21342), [#18596](https://github.com/anthropics/claude-code/issues/18596)).
**Task List Naming:** Auto-generated by `claude()` wrapper as `YYYYMMDD_HHmmss_UTC_<dirname>`. Override with `-t <name>` or `claude-new <desc>`.
**Task Subject Naming:** `[Component] Imperative action` (e.g., `[Auth] Refactor OAuth flow to JWT`)

**What works today:**
- `"plansDirectory": ".claude/plans"` in global `settings.json` → per-project plans
- `CLAUDE_CODE_TASK_LIST_ID` → auto-set by `claude()` shell wrapper (`config/aliases.sh`)

**Not yet available (revisit later):**
- `"tasksDirectory"` setting for per-project tasks → [#20425](https://github.com/anthropics/claude-code/issues/20425)
- Descriptive plan file names → [#21342](https://github.com/anthropics/claude-code/issues/21342)
- Project-level `plansDirectory` (global works, per-project buggy) → [#18623](https://github.com/anthropics/claude-code/issues/18623)
```

### 3. Update global CLAUDE.md directory convention table

**File:** `claude/CLAUDE.md`

Fix the Plans/Tasks rows to reflect reality:

```
| Plans  | `~/.claude/plans/` (use `plansDirectory` for per-project) | plans/ |
| Tasks  | `~/.claude/tasks/` (no per-project option yet)            | —      |
```

Update "Standard paths" and Notes sections to match.

### 4. Merge duplicate `claude()` wrappers

**File:** `config/aliases.sh`

Delete version 2 (lines 309-320). Merge its "only set if unset" guard into version 1 (lines 33-64):

```bash
claude() {
    # Use tmpfs for Claude Code temp files (faster, avoids disk I/O)
    if [[ "$OSTYPE" == linux* ]] && [[ -d "/run/user/$(id -u)" ]]; then
        export CLAUDE_CODE_TMPDIR="/run/user/$(id -u)"
    fi

    # Parse -t/--task argument for custom task name
    local args=() task_name=""
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -t|--task)
                task_name="$2"
                shift 2
                ;;
            *)
                args+=("$1")
                shift
                ;;
        esac
    done

    # Generate task list ID: -t flag always overrides, otherwise keep existing or auto-generate
    if [[ -n "$task_name" ]]; then
        # Explicit -t flag: always generate fresh with custom name
        local timestamp
        timestamp=$(date -u +%Y%m%d_%H%M%S)
        export CLAUDE_CODE_TASK_LIST_ID="${timestamp}_UTC_${task_name}"
    elif [[ -z "$CLAUDE_CODE_TASK_LIST_ID" ]]; then
        # No existing ID: auto-generate from directory name
        local suffix timestamp
        suffix=$(basename "$PWD" | tr ' ' '_')
        timestamp=$(date -u +%Y%m%d_%H%M%S)
        export CLAUDE_CODE_TASK_LIST_ID="${timestamp}_UTC_${suffix}"
    fi
    # else: keep existing CLAUDE_CODE_TASK_LIST_ID (set by claude-new, claude-with, etc.)

    activate_venv
    command claude "${args[@]}"
}
```

Key behaviors:
- `-t <name>`: always generates fresh ID with custom name
- Existing `CLAUDE_CODE_TASK_LIST_ID` (from `claude-new`, `claude-with`, etc.): preserved
- Neither: auto-generates from `dirname + timestamp`

## Files to modify

1. `claude/settings.json` — add `plansDirectory`
2. `claude/rules/workflow-defaults.md` — replace fake exports with real docs
3. `claude/CLAUDE.md` — fix directory convention table
4. `config/aliases.sh` — merge duplicate `claude()` wrappers, remove lines 309-320

## Verification

1. New Claude Code session in a non-dotfiles repo → plan file at `<repo>/.claude/plans/`
2. Confirm task list ID still auto-generated (existing `claude()` wrapper)
3. Confirm random plan name (known limitation, documented with issue links)
