#!/bin/zsh
# Clear Mac Apps - Manage running apps with configurable behavior
# Used by macOS Shortcuts via "Run Shell Script" action
#
# Config file supports two sections:
#   [no-touch]      - Apps to leave completely alone
#   [close-windows] - Apps where we close windows but don't quit

set -euo pipefail

SCRIPT_DIR="${0:A:h}"
CONFIG_FILE="${SCRIPT_DIR}/../config/clear_mac_apps.conf"

# Parse apps from a specific section in config
# Usage: get_apps_in_section "no-touch"
get_apps_in_section() {
    local section="$1"
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "Error: Config file not found: $CONFIG_FILE" >&2
        exit 1
    fi
    awk -v section="[$section]" '
        /^\[.*\]$/ { in_section = ($0 == section); next }
        in_section && !/^#/ && !/^[[:space:]]*$/ {
            gsub(/^[[:space:]]+|[[:space:]]+$/, "")
            if (length > 0) print
        }
    ' "$CONFIG_FILE"
}

# Get list of running GUI apps (one per line)
get_running_apps() {
    osascript -e 'tell application "System Events"
        set appList to name of every process whose background only is false
        set output to ""
        repeat with appName in appList
            set output to output & appName & linefeed
        end repeat
        return output
    end tell'
}

# Quit an app gracefully
quit_app() {
    local app="$1"
    osascript -e "tell application \"$app\" to quit" 2>/dev/null || true
}

# Close all windows of an app without quitting
close_app_windows() {
    local app="$1"
    osascript -e "
        tell application \"$app\"
            try
                close every window
            end try
        end tell
    " 2>/dev/null || true
}

main() {
    # Build associative arrays for O(1) lookup (keys are lowercase)
    typeset -A no_touch_set
    typeset -A close_windows_set

    while IFS= read -r app; do
        [[ -n "$app" ]] && no_touch_set[${(L)app}]=1
    done < <(get_apps_in_section "no-touch")

    while IFS= read -r app; do
        [[ -n "$app" ]] && close_windows_set[${(L)app}]=1
    done < <(get_apps_in_section "close-windows")

    # Get running apps
    local -a running_apps=()
    while IFS= read -r app; do
        [[ -n "$app" ]] && running_apps+=("$app")
    done < <(get_running_apps)

    # Process each running app
    for app in "${running_apps[@]}"; do
        local app_lower="${(L)app}"

        if (( ${+no_touch_set[$app_lower]} )); then
            # No-touch: skip completely
            continue
        elif (( ${+close_windows_set[$app_lower]} )); then
            # Close windows only
            echo "Closing windows: $app"
            close_app_windows "$app"
        else
            # Quit the app
            echo "Quitting: $app"
            quit_app "$app"
        fi
    done

    echo ""
    echo "Done."
    (( ${#no_touch_set} > 0 )) && echo "  No-touch: ${(k)no_touch_set}"
    (( ${#close_windows_set} > 0 )) && echo "  Close-windows: ${(k)close_windows_set}"
}

main "$@"
