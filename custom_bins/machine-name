#!/usr/bin/env bash

# Machine Name Script
#
# Outputs the machine name for SSH sessions, used by:
# - config/p10k.zsh (prompt_remote_host)
# - claude/statusline.sh (machine info display)
#
# Output format: "EMOJI NAME" (e.g., "ðŸ›œ hetzner-1")
# Outputs nothing if not in SSH session.
#
# Environment variables:
# - SERVER_NAME: Override the machine name entirely
# - MACHINE_EMOJI: Override the default emoji (ðŸ›œ)
#
# Priority for name resolution:
# 1. $SERVER_NAME env var
# 2. SSH config alias matching public IP
# 3. Abbreviated hostname (truncate if >10 chars)
#
# Uses cached public IP (~/.cache/public_ip, 1 hour TTL) to avoid slow network calls.

# Exit early if not in SSH session
[[ -z "$SSH_CONNECTION" ]] && exit 0

icon="${MACHINE_EMOJI:-ðŸ›œ}"
hostname="${HOST:-$(hostname -s)}"
short_name=""

# Option 1: Use SERVER_NAME env var if set
if [[ -n "$SERVER_NAME" ]]; then
  short_name="$SERVER_NAME"

# Option 2: Parse SSH config to find alias matching public IP
elif [[ -f ~/.ssh/config ]]; then
  cache_file="${HOME}/.cache/public_ip"
  public_ip=""

  # Check if cache exists and is fresh (less than 1 hour old)
  if [[ -f "$cache_file" ]]; then
    # Get file modification time (compatible with both macOS and Linux)
    if stat -c %Y "$cache_file" >/dev/null 2>&1; then
      file_mtime=$(stat -c %Y "$cache_file")
    else
      file_mtime=$(stat -f %m "$cache_file" 2>/dev/null || echo 0)
    fi
    current_time=$(date +%s)
    age=$((current_time - file_mtime))

    if [[ "$age" -lt 3600 ]]; then
      public_ip=$(cat "$cache_file" 2>/dev/null)
    fi
  fi

  # Fetch and cache public IP if not cached or stale
  if [[ -z "$public_ip" ]]; then
    mkdir -p "$(dirname "$cache_file")"
    public_ip=$(timeout 2 curl -s ifconfig.me 2>/dev/null || timeout 2 curl -s icanhazip.com 2>/dev/null)
    [[ -n "$public_ip" ]] && echo "$public_ip" > "$cache_file"
  fi

  # Try to match public IP against SSH config HostName entries
  if [[ -n "$public_ip" ]]; then
    short_name=$(awk -v target="$public_ip" '
      /^Host / {
        h = $2
        # Skip catch-all patterns like "*" or "*.domain.com"
        if (h ~ /^\*/) { host = ""; next }
        # Strip trailing wildcards: "hetzner-8*" -> "hetzner-8"
        gsub(/[*?]+$/, "", h)
        host = h
      }
      /^[[:space:]]*HostName / { if ($2 == target && host != "") print host }
    ' ~/.ssh/config | head -1)
  fi
fi

# Fallback: abbreviate long hostnames
if [[ -z "$short_name" ]]; then
  if (( ${#hostname} > 10 )); then
    short_name="${hostname:0:6}.."
  else
    short_name="$hostname"
  fi
fi

echo "$icon $short_name"
