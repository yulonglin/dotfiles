#!/usr/bin/env bash
# Discover Safari web apps and write a machine-local registry
# Used by clear-mac-apps for bundle ID fallback matching
#
# Output: config/safari_web_apps.local (gitignored, machine-specific UUIDs)

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REGISTRY="${SCRIPT_DIR}/../config/safari_web_apps.local"

# Search directories for Safari web apps
SEARCH_DIRS=(
    "$HOME/Applications"
    "$HOME/Applications/Safari Apps"
)

main() {
    local count=0
    local entries=()

    for dir in "${SEARCH_DIRS[@]}"; do
        [[ -d "$dir" ]] || continue
        for app in "$dir"/*.app; do
            [[ -d "$app" ]] || continue
            local plist="$app/Contents/Info.plist"
            [[ -f "$plist" ]] || continue

            local bid
            bid=$(defaults read "$app/Contents/Info" CFBundleIdentifier 2>/dev/null) || continue
            [[ "$bid" == com.apple.Safari.WebApp.* ]] || continue

            local name
            name=$(basename "$app" .app)
            entries+=("${name}|${bid}|${app}")
            count=$((count + 1))
        done
    done

    # Write registry
    {
        echo "# Auto-generated by safari-web-apps-scan on $(date -u '+%d-%m-%Y %H:%M UTC')"
        echo "# Format: name|bundle_id|path"
        echo "# Re-run: safari-web-apps-scan"
        for entry in "${entries[@]}"; do
            echo "$entry"
        done
    } > "$REGISTRY"

    echo "Found $count Safari web app(s) â†’ $REGISTRY"
    if (( count > 0 )); then
        printf '  %s\n' "${entries[@]}"
    fi
}

main "$@"
