# Fix: Focusmate Safari web app getting closed by clear-mac-apps

## Context

When `clear-mac-apps` runs, the Focusmate Safari web app gets quit despite being in `[no-touch]`. Root cause: `get_apps_in_section()` awk parser doesn't strip inline comments.

Config line 9: `Focusmate (Safari)  # Focusmate runs in Safari`
Parsed as: `Focusmate (Safari)  # Focusmate runs in Safari` (full line including comment)
Actual process name: `Focusmate (Safari)` (= CFBundleName from Info.plist)
Result: no match → web app falls through to quit list

Safari web apps are stored in `~/Applications/Safari Apps/` with bundle IDs like `com.apple.Safari.WebApp.<UUID>` (UUID is machine-specific).

## Phase 1: Fix inline comment bug (immediate)

### File: `custom_bins/clear-mac-apps` (line ~45, `get_apps_in_section()`)

Add `sub(/#.*/, "")` before whitespace trimming:

```awk
in_section && !/^#/ && !/^[[:space:]]*$/ {
    sub(/#.*/, "")                          # strip inline comments
    gsub(/^[[:space:]]+|[[:space:]]+$/, "")
    if (length > 0) print
}
```

Same fix needed in `custom_bins/clear-mac-apps-export` if it has the same parser.

## Phase 2: Safari web app registry (robustness)

### New script: `custom_bins/safari-web-apps-scan`

Auto-discovers Safari web apps and writes a machine-local registry:

```bash
# Scans ~/Applications/ and ~/Applications/Safari Apps/ recursively
# Finds .app bundles with com.apple.Safari.WebApp.* bundle IDs
# Outputs: config/safari_web_apps.local
```

Output format (`config/safari_web_apps.local`):
```
# Auto-generated by safari-web-apps-scan on 2026-02-20
# Format: name|bundle_id|path
Focusmate (Safari)|com.apple.Safari.WebApp.1FB0C69B-...|~/Applications/Safari Apps/Focusmate (Safari).app
Claude (Safari)|com.apple.Safari.WebApp.317E4A60-...|~/Applications/Safari Apps/Claude (Safari).app
```

### Gitignore: `config/safari_web_apps.local` (machine-specific UUIDs)

### Integration with `clear-mac-apps`

Enhance `get_running_apps()` to return both name and bundle ID. Match against bundle ID from registry as fallback when name match fails. This makes the config resilient to web app renames.

### Optional: run scan during `deploy.sh`

Add `safari-web-apps-scan` call to deploy to keep registry fresh.

## Verification

1. `clear-mac-apps --dry-run` — Focusmate (Safari) must appear under "Would SKIP (no-touch)"
2. Other no-touch apps (Ghostty, Things, zoom.us, Codex) still protected
3. Close-windows and slow-close apps still parse correctly
4. `safari-web-apps-scan` produces correct mapping for all 8 web apps in `~/Applications/Safari Apps/`
